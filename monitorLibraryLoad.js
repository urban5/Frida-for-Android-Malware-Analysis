// This script checks if the native library is loaded before and after the method call to determine the moment for hooking the native function
//SHA256 of the sample, following script was used on: 2c05efa757744cb01346fe6b39e9ef8ea2582d27481a441eb885c5c4dcd2b65b
//Detailed unpacking of the sample available in another article written by Cryptax: https://cryptax.medium.com/inside-kangapack-the-kangaroo-packer-with-native-decryption-3e7e054679c4

Java.perform(function () {
    // Define the target class and method
    var targetClass = "com.hwgapkspv.gouhwkh.XBFkfYNbujfaaLbgYxmf";
    var targetMethod = "bhwi8sma09d23ssva";

    // Get a reference to the target class
    var TargetClass = Java.use(targetClass);

    // Hook the method implementation
    TargetClass[targetMethod].overload('java.io.File', 'java.lang.String').implementation = function (file, name) {
        console.log(" === Hooked " + targetMethod);

        // Check if the library is loaded before the method execution
        var isLibraryLoadedBefore = false;
        Process.enumerateModules({
            onMatch: function(module) {
                if (module.name === "libapksadfsalkwes.so") {
                    isLibraryLoadedBefore = true;
                    console.log("[*] Library libapksadfsalkwes.so is loaded before method execution");
                }
            },
            onComplete: function() {
                if (!isLibraryLoadedBefore) {
                    console.log("[*] Library libapksadfsalkwes.so is not loaded before method execution");
                }
            }
        });

        // Call the original method and return its result
        var result = this[targetMethod](file, name);

        // Check if the library is loaded after the method execution
        var isLibraryLoadedAfter = false;
        Process.enumerateModules({
            onMatch: function(module) {
                if (module.name === "libapksadfsalkwes.so") {
                    isLibraryLoadedAfter = true;
                    console.log("[*] Library libapksadfsalkwes.so is loaded after method execution");
                }
            },
            onComplete: function() {
                if (!isLibraryLoadedAfter) {
                    console.log("[*] Library libapksadfsalkwes.so is not loaded after method execution");
                }
            }
        });

        return result;
    };
});
